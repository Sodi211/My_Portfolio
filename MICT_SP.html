<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MICT SP Insights Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    /* Performance filter buttons */
    .performance-filter {
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
      background-color: #f3f4f6;
      color: #4b5563;
      cursor: pointer;
      transition: all 0.2s;
    }

    .performance-filter:hover {
      background-color: #e5e7eb;
    }

    .performance-filter.active {
      background-color: #3b82f6;
      color: white;
    }

    /* Table styles */
    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      background-color: #f9fafb;
      text-align: left;
      padding: 0.75rem 1rem;
      font-weight: 600;
      color: #374151;
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.05em;
      border-bottom: 1px solid #e5e7eb;
    }

    td {
      padding: 1rem;
      border-bottom: 1px solid #e5e7eb;
      font-size: 0.875rem;
      color: #4b5563;
    }

    tr:hover {
      background-color: #f9fafb;
    }

    /* Category colors - Enhanced visibility */
    .tr-excellent {
      background-color: rgba(16, 185, 129, 0.15) !important;
    }

    .tr-excellent:hover {
      background-color: rgba(16, 185, 129, 0.25) !important;
    }

    .tr-moderate {
      background-color: rgba(245, 158, 11, 0.15) !important;
    }

    .tr-moderate:hover {
      background-color: rgba(245, 158, 11, 0.25) !important;
    }

    .tr-at-risk {
      background-color: rgba(239, 68, 68, 0.15) !important;
    }

    .tr-at-risk:hover {
      background-color: rgba(239, 68, 68, 0.25) !important;
    }

    /* Chart container */
    .chart {
      width: 100%;
    }

    /* KPI cards */
    .kpi-card {
      border-left: 4px solid;
      transition: all 0.3s ease;
    }

    .kpi-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    /* Loading states */
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }

    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
    }

    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    
    /* Fade in animation */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-out forwards;
    }
    
    /* Page transition */
    .page-transition {
      transition: opacity 0.3s ease;
    }
    
    .page-hidden {
      opacity: 0;
      pointer-events: none;
      display: none;
    }
    
    .page-visible {
      opacity: 1;
      display: block;
    }
    
    /* Active navigation item */
    .nav-active {
      background-color: #dbeafe;
      color: #1e40af;
    }
    
    /* Export modal */
    .export-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .export-modal-content {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }
    
    /* Chart export styles */
    .chart-export {
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      margin-bottom: 20px;
      page-break-inside: avoid;
    }
    
    /* Enhanced color badges */
    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .status-badge.excellent {
      background-color: #d1fae5;
      color: #065f46;
    }
    
    .status-badge.moderate {
      background-color: #fef3c7;
      color: #92400e;
    }
    
    .status-badge.at-risk {
      background-color: #fee2e2;
      color: #991b1b;
    }
  </style>
</head>
<body class="bg-gray-50">
  <!-- Loading indicator -->
  <div id="loadingIndicator" class="fixed inset-0 bg-white bg-opacity-80 flex items-center justify-center z-50">
    <div class="text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
      <p class="text-gray-600">Loading dashboard...</p>
    </div>
  </div>

  <!-- Export Modal -->
  <div id="exportModal" class="export-modal page-hidden">
    <div class="export-modal-content">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold text-gray-800">Export Report</h3>
        <button id="closeExportModal" class="text-gray-400 hover:text-gray-600">
          <i data-feather="x" class="w-5 h-5"></i>
        </button>
      </div>
      
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Export Format</label>
          <div class="grid grid-cols-2 gap-3">
            <button class="export-format-btn border border-gray-300 rounded-lg p-3 text-left hover:border-blue-500 hover:bg-blue-50 transition-colors" data-format="pdf">
              <div class="flex items-center">
                <i data-feather="file-text" class="text-red-500 mr-2"></i>
                <span>PDF Document</span>
              </div>
              <p class="text-xs text-gray-500 mt-1">High-quality report with charts</p>
            </button>
            <button class="export-format-btn border border-gray-300 rounded-lg p-3 text-left hover:border-blue-500 hover:bg-blue-50 transition-colors" data-format="csv">
              <div class="flex items-center">
                <i data-feather="file-text" class="text-green-500 mr-2"></i>
                <span>CSV Data</span>
              </div>
              <p class="text-xs text-gray-500 mt-1">Raw data for analysis</p>
            </button>
          </div>
        </div>
        
        <div id="pdfOptions" class="space-y-3">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Report Title</label>
            <input type="text" id="reportTitle" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" value="MICT SP Performance Analysis Report">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Data Scope</label>
            <div class="space-y-2">
              <label class="flex items-center">
                <input type="radio" name="dataScope" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" value="current" checked>
                <span class="ml-2 text-sm text-gray-700">Current filtered view</span>
              </label>
              <label class="flex items-center">
                <input type="radio" name="dataScope" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" value="all">
                <span class="ml-2 text-sm text-gray-700">All data (ignore filters)</span>
              </label>
            </div>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Include Sections</label>
            <div class="space-y-2">
              <label class="flex items-center">
                <input type="checkbox" class="section-checkbox rounded border-gray-300 text-blue-600 focus:ring-blue-500" data-section="executive" checked>
                <span class="ml-2 text-sm text-gray-700">Executive Summary</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" class="section-checkbox rounded border-gray-300 text-blue-600 focus:ring-blue-500" data-section="kpis" checked>
                <span class="ml-2 text-sm text-gray-700">Performance Metrics</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" class="section-checkbox rounded border-gray-300 text-blue-600 focus:ring-blue-500" data-section="charts" checked>
                <span class="ml-2 text-sm text-gray-700">Charts & Visualizations</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" class="section-checkbox rounded border-gray-300 text-blue-600 focus:ring-blue-500" data-section="risk" checked>
                <span class="ml-2 text-sm text-gray-700">Risk Analysis</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" class="section-checkbox rounded border-gray-300 text-blue-600 focus:ring-blue-500" data-section="recommendations" checked>
                <span class="ml-2 text-sm text-gray-700">Recommendations</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" class="section-checkbox rounded border-gray-300 text-blue-600 focus:ring-blue-500" data-section="detailed" checked>
                <span class="ml-2 text-sm text-gray-700">Detailed Data</span>
              </label>
            </div>
          </div>
        </div>
        
        <div class="flex justify-end space-x-3 pt-4">
          <button id="cancelExport" class="px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
            Cancel
          </button>
          <button id="confirmExport" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center">
            <i data-feather="download" class="w-4 h-4 mr-2"></i>
            Export Report
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Dashboard Page -->
  <div id="dashboard-page" class="page-transition page-visible">
    <!-- Main Content -->
    <div id="mainContent" class="container mx-auto px-4 py-6 opacity-0">
      <!-- Dashboard Header -->
      <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 fade-in">
        <div>
          <h1 class="text-3xl font-bold text-gray-800">MICT SP Performance Analysis</h1>
          <p class="text-gray-600">Comprehensive candidate performance analytics</p>
        </div>
        <div class="mt-4 md:mt-0">
          <button id="exportReportBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors">
            <i data-feather="download"></i> Export Full Report
          </button>
        </div>
      </div>

      <!-- Filters -->
      <div class="bg-white rounded-xl shadow-sm p-4 mb-6 fade-in">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Dev group</label>
            <select id="groupSel" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Scrum / week</label>
            <select id="weekSel" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Search candidate</label>
            <input id="searchIn" type="text" placeholder="Type a name..." class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" />
          </div>
          <div class="flex items-end">
            <button id="resetBtn" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg flex items-center justify-center gap-2 transition-colors">
              <i data-feather="refresh-cw"></i> Reset
            </button>
          </div>
        </div>
      </div>

      <!-- Detailed Table - MOVED TO TOP -->
      <div class="bg-white rounded-xl shadow-sm overflow-hidden mb-6 fade-in">
        <div class="flex justify-between items-center p-4 border-b">
          <h3 class="text-lg font-semibold text-gray-800">Candidate Details</h3>
          <div class="flex items-center gap-2 text-sm">
            <span class="text-gray-500">Showing <span id="candidateCount" class="font-medium">0</span> candidates</span>
            <button class="text-blue-600 hover:text-blue-800 flex items-center gap-1 transition-colors">
              <i data-feather="filter" class="w-4 h-4"></i>
              <span>Filter</span>
            </button>
          </div>
        </div>
        <div id="tableWrap" class="overflow-x-auto">
          <div class="skeleton p-4 h-64"></div>
        </div>
      </div>

      <!-- KPIs -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-6" id="kpiRow">
        <!-- Skeleton loading -->
        <div class="kpi-card skeleton rounded-xl p-4 h-20 fade-in"></div>
        <div class="kpi-card skeleton rounded-xl p-4 h-20 fade-in"></div>
        <div class="kpi-card skeleton rounded-xl p-4 h-20 fade-in"></div>
        <div class="kpi-card skeleton rounded-xl p-4 h-20 fade-in"></div>
        <div class="kpi-card skeleton rounded-xl p-4 h-20 fade-in"></div>
      </div>

      <!-- NEW: Performance Trends Over Time -->
      <div class="bg-white rounded-xl shadow-sm p-4 mb-6 fade-in">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Performance Trends</h3>
        <div id="performanceTrends" class="chart h-80 skeleton rounded-lg"></div>
      </div>

      <!-- Main Charts -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Overall Distribution -->
        <div class="bg-white rounded-xl shadow-sm p-4 fade-in">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-800">Performance Distribution</h3>
            <div class="flex gap-2">
              <button class="performance-filter active" data-filter="all">All</button>
              <button class="performance-filter" data-filter="excellent">Excellent</button>
              <button class="performance-filter" data-filter="moderate">Moderate</button>
              <button class="performance-filter" data-filter="at-risk">At Risk</button>
            </div>
          </div>
          <div id="overallDist" class="chart h-80 skeleton rounded-lg"></div>
        </div>

        <!-- Group Comparison -->
        <div class="bg-white rounded-xl shadow-sm p-4 fade-in">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-800">Group Performance Comparison</h3>
            <div class="flex items-center gap-2 text-sm text-gray-500">
              <i data-feather="info" class="w-4 h-4"></i>
              <span>Hover for details</span>
            </div>
          </div>
          <div id="groupCompare" class="chart h-80 skeleton rounded-lg"></div>
        </div>
      </div>

      <!-- NEW: Skill Distribution by Category -->
      <div class="bg-white rounded-xl shadow-sm p-4 mb-6 fade-in">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Skill Distribution by Performance Category</h3>
        <div id="skillDistribution" class="chart h-80 skeleton rounded-lg"></div>
      </div>

      <!-- Secondary Charts -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Radar Chart -->
        <div class="bg-white rounded-xl shadow-sm p-4 fade-in">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">Skills Radar</h3>
          <div id="criteriaRadar" class="chart h-80 skeleton rounded-lg"></div>
        </div>

        <!-- Scatter Plot - IMPROVED with clear colors and all candidates -->
        <div class="bg-white rounded-xl shadow-sm p-4 fade-in">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-800">Tech vs Soft Skills</h3>
            <div class="flex items-center gap-2">
              <div class="flex items-center gap-1">
                <span class="w-3 h-3 rounded-full bg-green-500"></span>
                <span class="text-xs">Excellent</span>
              </div>
              <div class="flex items-center gap-1">
                <span class="w-3 h-3 rounded-full bg-amber-500"></span>
                <span class="text-xs">Moderate</span>
              </div>
              <div class="flex items-center gap-1">
                <span class="w-3 h-3 rounded-full bg-red-500"></span>
                <span class="text-xs">At Risk</span>
              </div>
            </div>
          </div>
          <div id="techSoftScatter" class="chart h-80 skeleton rounded-lg"></div>
        </div>
      </div>

      <!-- NEW: Performance by Group (Box Plots) -->
      <div class="bg-white rounded-xl shadow-sm p-4 mb-6 fade-in">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Performance Distribution by Group</h3>
        <div id="groupBoxPlots" class="chart h-80 skeleton rounded-lg"></div>
      </div>

      <!-- Correlation Matrix -->
      <div class="bg-white rounded-xl shadow-sm p-4 mb-6 fade-in">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Skills Correlation Matrix</h3>
        <div id="correlationMatrix" class="chart h-96 skeleton rounded-lg"></div>
      </div>

      <!-- NEW: Top Performers & At-Risk Candidates -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Top Performers -->
        <div class="bg-white rounded-xl shadow-sm p-4 fade-in">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">Top Performers</h3>
          <div id="topPerformers" class="space-y-3">
            <div class="skeleton rounded-lg p-4 h-16"></div>
            <div class="skeleton rounded-lg p-4 h-16"></div>
            <div class="skeleton rounded-lg p-4 h-16"></div>
          </div>
        </div>

        <!-- At-Risk Candidates -->
        <div class="bg-white rounded-xl shadow-sm p-4 fade-in">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">At-Risk Candidates</h3>
          <div id="atRiskCandidates" class="space-y-3">
            <div class="skeleton rounded-lg p-4 h-16"></div>
            <div class="skeleton rounded-lg p-4 h-16"></div>
            <div class="skeleton rounded-lg p-4 h-16"></div>
          </div>
        </div>
      </div>

      <!-- Insights & Recommendations -->
      <div class="bg-white rounded-xl shadow-sm p-6 mb-6 fade-in">
        <h3 class="text-xl font-bold text-gray-800 mb-4">Insights & Recommendations</h3>
        <div id="insightsContent" class="prose max-w-none">
          <div class="skeleton rounded-lg p-4 h-32"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Enhanced dataset with ALL groups and candidates - UPDATED with only 6 skills
    const ALL_DATA = [
      // Scan-Tech (5)
      {Candidate:"Aldo Stevens", Scrum:"Mini presentation", DevGroup:"Scan-Tech", 
       Attendance:5, Communication:3, Accountability:3, CreativityOwnership:3, ProjectDelivery:1, TechSkills:4},
      {Candidate:"Charlton Steenkamp", Scrum:"Mini presentation", DevGroup:"Scan-Tech", 
       Attendance:5, Communication:3, Accountability:3, CreativityOwnership:3, ProjectDelivery:3, TechSkills:3},
      {Candidate:"Olona Mqongwana", Scrum:"Mini presentation", DevGroup:"Scan-Tech", 
       Attendance:3, Communication:3, Accountability:3, CreativityOwnership:4, ProjectDelivery:4, TechSkills:3},
      {Candidate:"Nontobeko Nkomo", Scrum:"Mini presentation", DevGroup:"Scan-Tech", 
       Attendance:2, Communication:3, Accountability:3, CreativityOwnership:2, ProjectDelivery:2, TechSkills:2},
      {Candidate:"Siyanda Dube", Scrum:"Mini presentation", DevGroup:"Scan-Tech", 
       Attendance:5, Communication:3, Accountability:3, CreativityOwnership:3, ProjectDelivery:1, TechSkills:4},

      // PinCoders (5)
      {Candidate:"Anele Ngcatshe", Scrum:"Mini presentation", DevGroup:"PinCoders", 
       Attendance:4, Communication:3, Accountability:3, CreativityOwnership:3, ProjectDelivery:3, TechSkills:3},
      {Candidate:"Ceshia Williams", Scrum:"Mini presentation", DevGroup:"PinCoders", 
       Attendance:3, Communication:3, Accountability:3, CreativityOwnership:2, ProjectDelivery:2, TechSkills:2},
      {Candidate:"Lwazi Nhleko", Scrum:"Mini presentation", DevGroup:"PinCoders", 
       Attendance:3, Communication:3, Accountability:3, CreativityOwnership:2, ProjectDelivery:2, TechSkills:2},
      {Candidate:"Thando Valley", Scrum:"Mini presentation", DevGroup:"PinCoders", 
       Attendance:4, Communication:3, Accountability:3, CreativityOwnership:3, ProjectDelivery:4, TechSkills:4},
      {Candidate:"Zanele Gulwa", Scrum:"Mini presentation", DevGroup:"PinCoders", 
       Attendance:3, Communication:3, Accountability:3, CreativityOwnership:2, ProjectDelivery:1, TechSkills:3},

      // HTML Pioneers (5)
      {Candidate:"Aphiwe Tyhalisi", Scrum:"Mini presentation", DevGroup:"HTML Pioneers", 
       Attendance:5, Communication:3, Accountability:3, CreativityOwnership:3, ProjectDelivery:4, TechSkills:4},
      {Candidate:"Ashura Noordien", Scrum:"Mini presentation", DevGroup:"HTML Pioneers", 
       Attendance:5, Communication:2, Accountability:3, CreativityOwnership:2, ProjectDelivery:2, TechSkills:2},
      {Candidate:"Layola Mbula", Scrum:"Mini presentation", DevGroup:"HTML Pioneers", 
       Attendance:5, Communication:4, Accountability:3, CreativityOwnership:4, ProjectDelivery:4, TechSkills:4},
      {Candidate:"Mdumiseni Radebe", Scrum:"Mini presentation", DevGroup:"HTML Pioneers", 
       Attendance:5, Communication:3, Accountability:3, CreativityOwnership:3, ProjectDelivery:3, TechSkills:3},
      {Candidate:"Athandile Nkcaza", Scrum:"Mini presentation", DevGroup:"HTML Pioneers", 
       Attendance:4, Communication:3, Accountability:3, CreativityOwnership:3, ProjectDelivery:3, TechSkills:4},

      // A-Green Culture (5)
      {Candidate:"Amahle Ngongeni", Scrum:"Mini presentation", DevGroup:"A-Green Culture", 
       Attendance:5, Communication:3, Accountability:3, CreativityOwnership:2, ProjectDelivery:3, TechSkills:3},
      {Candidate:"Inganathi Mpahleni", Scrum:"Mini presentation", DevGroup:"A-Green Culture", 
       Attendance:4, Communication:3, Accountability:3, CreativityOwnership:3, ProjectDelivery:2, TechSkills:3},
      {Candidate:"Mika'eel Albertyn", Scrum:"Mini presentation", DevGroup:"A-Green Culture", 
       Attendance:5, Communication:3, Accountability:4, CreativityOwnership:4, ProjectDelivery:4, TechSkills:5},
      {Candidate:"Naelin Churches", Scrum:"Mini presentation", DevGroup:"A-Green Culture", 
       Attendance:5, Communication:3, Accountability:4, CreativityOwnership:4, ProjectDelivery:4, TechSkills:4},
      {Candidate:"Phola Mavumengwana", Scrum:"Mini presentation", DevGroup:"A-Green Culture", 
       Attendance:4, Communication:3, Accountability:3, CreativityOwnership:3, ProjectDelivery:3, TechSkills:3},
    ];

    // Calculate overall score for each candidate and add to dataset
    ALL_DATA.forEach(candidate => {
      // Calculate overall score percentage: (SUM(skills)/30)*100
      const skills = [
        candidate.Attendance,
        candidate.Communication,
        candidate.Accountability,
        candidate.CreativityOwnership,
        candidate.ProjectDelivery,
        candidate.TechSkills
      ];
      const sum = skills.reduce((total, score) => total + score, 0);
      candidate.OverallScore = (sum / 30) * 100;
    });

    // Current working dataset (can be filtered)
    let DATA = [...ALL_DATA];

    // Helper functions
    const fmt = (v, d=2) => (v==null || isNaN(v)) ? "N/A" : Number(v).toFixed(d);
    const unique = arr => Array.from(new Set(arr));
    
    // Soft skills average (Communication, Accountability, CreativityOwnership)
    function softSkillAvg(r){ 
      return (r.Communication + r.Accountability + r.CreativityOwnership) / 3; 
    }
    
    // Overall average using only the 6 skills
    function overallAvg(r){
      return (r.Attendance + r.Communication + r.Accountability + 
              r.CreativityOwnership + r.ProjectDelivery + r.TechSkills) / 6;
    }
    
    function isAtRisk(r){
      return (r.Attendance<=2 || r.Communication<=2 || r.Accountability<=2 || 
              r.CreativityOwnership<=2 || r.ProjectDelivery<=2 || r.TechSkills<=2);
    }
    
    function category(r){
      if(isAtRisk(r)) return "At-risk";
      const avg = overallAvg(r);
      if(avg >= 4) return "Excellent";
      if(avg >= 2.5 && avg <= 3.5) return "Moderate";
      return "Moderate";
    }
    
    function colorByCategory(cat){
      return cat==="At-risk" ? "#ef4444" : (cat==="Excellent" ? "#10b981" : "#f59e0b");
    }

    // Filters
    const groupSel = document.getElementById('groupSel');
    const weekSel  = document.getElementById('weekSel');
    const searchIn = document.getElementById('searchIn');
    const resetBtn = document.getElementById('resetBtn');

    function initFilters() {
      const groups = ["All", ...unique(ALL_DATA.map(d=>d.DevGroup)).sort()];
      const weeks  = ["All", ...unique(ALL_DATA.map(d=>d.Scrum)).sort()];
      groupSel.innerHTML = groups.map(g=>`<option value="${g}">${g}</option>`).join('');
      weekSel.innerHTML  = weeks.map(w=>`<option value="${w}">${w}</option>`).join('');
      groupSel.value = "All"; weekSel.value = "All"; searchIn.value = "";
    }

    function filterData() {
      const group = groupSel.value;
      const week = weekSel.value;
      const q = searchIn.value.trim().toLowerCase();
      return DATA.filter(r => {
        const okG = group==="All" ? true : r.DevGroup===group;
        const okW = week==="All" ? true : String(r.Scrum)===String(week);
        const okQ = q==="" ? true : String(r.Candidate).toLowerCase().includes(q);
        return okG && okW && okQ;
      });
    }

    // KPIs
    function renderKPIs(rows) {
      const el = document.getElementById('kpiRow');
      const avg = key => {
        const vals = rows.map(r=>r[key]).filter(v=>v!=null && !isNaN(v));
        return vals.length ? vals.reduce((a,b)=>a+b,0)/vals.length : NaN;
      };
      
      const att = avg("Attendance");
      const acc = avg("Accountability");
      const workReady = rows.length ? (rows.filter(r=>r.TechSkills>=4).length/rows.length*100) : NaN;
      const needsSupport = rows.length ? (rows.filter(r=>isAtRisk(r)).length/rows.length*100) : NaN;
      const avgOverallScore = rows.length ? (rows.reduce((sum, r) => sum + r.OverallScore, 0) / rows.length) : NaN;

      el.innerHTML = `
        <div class="kpi-card bg-white rounded-xl shadow-sm p-4 border-l-4 border-blue-500 fade-in">
          <div class="text-sm text-gray-500">Average Attendance</div>
          <div class="text-2xl font-bold text-gray-800">${fmt(att)}/5</div>
          <div class="text-xs text-gray-400 mt-1">${att >= 4 ? 'Excellent' : att >= 3 ? 'Good' : 'Needs Improvement'}</div>
        </div>
        <div class="kpi-card bg-white rounded-xl shadow-sm p-4 border-l-4 border-green-500 fade-in">
          <div class="text-sm text-gray-500">Average Accountability</div>
          <div class="text-2xl font-bold text-gray-800">${fmt(acc)}/5</div>
          <div class="text-xs text-gray-400 mt-1">${acc >= 4 ? 'High' : acc >= 3 ? 'Moderate' : 'Low'}</div>
        </div>
        <div class="kpi-card bg-white rounded-xl shadow-sm p-4 border-l-4 border-teal-500 fade-in">
          <div class="text-sm text-gray-500">Work Ready (Tech ≥ 4)</div>
          <div class="text-2xl font-bold text-gray-800">${isNaN(workReady)?"N/A":Math.round(workReady)}%</div>
          <div class="text-xs text-gray-400 mt-1">Strong technical skills</div>
        </div>
        <div class="kpi-card bg-white rounded-xl shadow-sm p-4 border-l-4 border-red-500 fade-in">
          <div class="text-sm text-gray-500">Need Support</div>
          <div class="text-2xl font-bold text-gray-800">${isNaN(needsSupport)?"N/A":Math.round(needsSupport)}%</div>
          <div class="text-xs text-gray-400 mt-1">≤2 in any criteria</div>
        </div>
        <div class="kpi-card bg-white rounded-xl shadow-sm p-4 border-l-4 border-purple-500 fade-in">
          <div class="text-sm text-gray-500">Overall Score</div>
          <div class="text-2xl font-bold text-gray-800">${isNaN(avgOverallScore)?"N/A":Math.round(avgOverallScore)}%</div>
          <div class="text-xs text-gray-400 mt-1">Average performance</div>
        </div>
      `;
    }

    // NEW: Performance Trends Over Time
    function renderPerformanceTrends(rows) {
      // Simulate performance trends over weeks
      const groups = unique(rows.map(r => r.DevGroup));
      const weeks = ['Week 1', 'Week 2', 'Week 3', 'Week 4'];
      
      const traces = groups.map(group => {
        const groupData = rows.filter(r => r.DevGroup === group);
        // Simulate trend data (in a real app, this would come from historical data)
        const baseAvg = groupData.reduce((sum, r) => sum + overallAvg(r), 0) / groupData.length;
        const trend = weeks.map((_, i) => {
          // Simulate some variation in performance over time
          const variation = (Math.random() * 0.5) - 0.25;
          return Math.max(1, Math.min(5, baseAvg + variation * (i + 1)));
        });
        
        return {
          type: 'scatter',
          mode: 'lines+markers',
          name: group,
          x: weeks,
          y: trend,
          line: { width: 3 },
          marker: { size: 8 }
        };
      });
      
      const layout = {
        margin: { l: 50, r: 30, t: 30, b: 50 },
        xaxis: { title: 'Week' },
        yaxis: { title: 'Average Performance Score', range: [1, 5] },
        template: 'plotly_white',
        showlegend: true,
        legend: { orientation: 'h', y: -0.2 }
      };
      
      Plotly.newPlot('performanceTrends', traces, layout, { responsive: true });
    }

    // Chart 1: Overall Category Distribution (Donut)
    function renderOverallCategory(rows) {
      const cats = rows.map(category);
      const labels = ["Excellent","Moderate","At-risk"];
      const counts = labels.map(l => cats.filter(c => c===l).length);
      const colors = ["#10b981","#f59e0b","#ef4444"];
      const data = [{
        type: "pie",
        labels: labels,
        values: counts,
        hole: 0.45,
        marker: {colors: colors},
        textinfo: "label+percent",
        hovertemplate: "%{label}: %{value} candidates<extra></extra>"
      }];
      const layout = { 
        margin: {l:20,r:20,t:10,b:10}, 
        template: "plotly_white", 
        showlegend: true,
        height: 320
      };
      Plotly.newPlot("overallDist", data, layout, {responsive:true});
    }

    // Chart 2: Group Comparison by Category (Clustered Bar)
    function renderGroupComparison(rows) {
      const groups = Array.from(new Set(rows.map(r => r.DevGroup)));
      const categories = ["Excellent","Moderate","At-risk"];
      const colorMap = {"Excellent":"#10b981","Moderate":"#f59e0b","At-risk":"#ef4444"};

      const countsByGroupCat = (group, cat) =>
        rows.filter(r => r.DevGroup===group && category(r)===cat).length;

      const traces = categories.map(cat => ({
        type: "bar",
        name: cat,
        x: groups,
        y: groups.map(g => countsByGroupCat(g, cat)),
        marker: {color: colorMap[cat]},
        hovertemplate: "%{x}<br>"+cat+": %{y}<extra></extra>"
      }));

      const layout = {
        barmode: "group",
        margin: {l:40,r:20,t:10,b:40},
        yaxis: {title: "Candidates"},
        xaxis: {title: "Dev group"},
        template: "plotly_white",
        legend: {orientation: "h", y: -0.2},
        height: 320
      };
      Plotly.newPlot("groupCompare", traces, layout, {responsive:true});
    }

    // NEW: Skill Distribution by Category
    function renderSkillDistribution(rows) {
      const categories = ["Excellent", "Moderate", "At-risk"];
      const skills = ["Attendance", "Communication", "Accountability", "CreativityOwnership", 
                     "ProjectDelivery", "TechSkills"];
      
      const traces = categories.map(cat => {
        const catData = rows.filter(r => category(r) === cat);
        const skillAverages = skills.map(skill => {
          const sum = catData.reduce((total, r) => total + r[skill], 0);
          return sum / catData.length;
        });
        
        return {
          type: 'bar',
          name: cat,
          x: skills.map(s => s.replace(/([A-Z])/g, ' $1').trim()),
          y: skillAverages,
          marker: { color: colorByCategory(cat) }
        };
      });
      
      const layout = {
        barmode: 'group',
        margin: { l: 50, r: 30, t: 30, b: 100 },
        xaxis: { 
          title: 'Skills',
          tickangle: -45
        },
        yaxis: { 
          title: 'Average Score',
          range: [0, 5]
        },
        template: 'plotly_white',
        showlegend: true,
        legend: { orientation: 'h', y: -0.3 }
      };
      
      Plotly.newPlot('skillDistribution', traces, layout, { responsive: true });
    }

    // Chart 3: Criteria Averages (Radar) - UPDATED with only 6 skills
    function renderCriteriaRadar(rows) {
      const criteria = ["Attendance","Communication","Accountability","CreativityOwnership","ProjectDelivery","TechSkills"];
      const labels = ["Attendance","Communication","Accountability","Creativity & Ownership","Project Delivery","Tech Skills"];
      const means = criteria.map(c => {
        const vals = rows.map(r => r[c]).filter(v => v!=null && !isNaN(v));
        return vals.length ? vals.reduce((a,b)=>a+b,0)/vals.length : null;
      });

      const data = [{
        type: "scatterpolar",
        r: means,
        theta: labels,
        fill: "toself",
        name: "Cohort average",
        marker: {color: "#3b82f6"}
      }];
      const layout = {
        polar: { radialaxis: { visible: true, range: [1,5] } },
        showlegend: false,
        margin:{l:40,r:20,t:10,b:40},
        template:"plotly_white",
        height: 320
      };
      Plotly.newPlot("criteriaRadar", data, layout, {responsive:true});
    }

    // Chart 4: Tech vs Soft Skills Scatter - IMPROVED with clear colors and all candidates
    function renderTechSoftScatter(rows) {
      // Create separate traces for each category to ensure all candidates are shown
      const excellentData = rows.filter(r => category(r) === "Excellent");
      const moderateData = rows.filter(r => category(r) === "Moderate");
      const atRiskData = rows.filter(r => category(r) === "At-risk");
      
      const traces = [
        {
          type: "scatter",
          mode: "markers",
          name: "Excellent",
          x: excellentData.map(r => r.TechSkills),
          y: excellentData.map(r => softSkillAvg(r)),
          text: excellentData.map(r => r.Candidate),
          marker: {
            size: 12,
            color: "#10b981", // Clear green
            line: { width: 1, color: "#0a8c63" }
          },
          hovertemplate: "<b>%{text}</b><br>Tech: %{x}<br>Soft (avg): %{y:.2f}<extra></extra>"
        },
        {
          type: "scatter",
          mode: "markers",
          name: "Moderate",
          x: moderateData.map(r => r.TechSkills),
          y: moderateData.map(r => softSkillAvg(r)),
          text: moderateData.map(r => r.Candidate),
          marker: {
            size: 12,
            color: "#f59e0b", // Clear amber
            line: { width: 1, color: "#d97706" }
          },
          hovertemplate: "<b>%{text}</b><br>Tech: %{x}<br>Soft (avg): %{y:.2f}<extra></extra>"
        },
        {
          type: "scatter",
          mode: "markers",
          name: "At Risk",
          x: atRiskData.map(r => r.TechSkills),
          y: atRiskData.map(r => softSkillAvg(r)),
          text: atRiskData.map(r => r.Candidate),
          marker: {
            size: 12,
            color: "#ef4444", // Clear red
            line: { width: 1, color: "#dc2626" }
          },
          hovertemplate: "<b>%{text}</b><br>Tech: %{x}<br>Soft (avg): %{y:.2f}<extra></extra>"
        }
      ];

      const layout = {
        xaxis: {title: "Technical Skills", range: [0.5,5.5], gridcolor: "#e5e7eb"},
        yaxis: {title: "Soft Skills (avg)", range: [0.5,5.5], gridcolor: "#e5e7eb"},
        margin: {l:50,r:20,t:10,b:50},
        template: "plotly_white",
        showlegend: true,
        legend: { orientation: "h", y: -0.2 },
        height: 320
      };

      Plotly.newPlot("techSoftScatter", traces, layout, {responsive:true});
    }

    // NEW: Performance by Group (Box Plots)
    function renderGroupBoxPlots(rows) {
      const groups = unique(rows.map(r => r.DevGroup));
      
      const traces = groups.map(group => {
        const groupData = rows.filter(r => r.DevGroup === group);
        const scores = groupData.map(r => overallAvg(r));
        
        return {
          type: 'box',
          name: group,
          y: scores,
          boxpoints: 'all',
          jitter: 0.3,
          pointpos: -1.8,
          marker: { size: 4 },
          line: { width: 2 }
        };
      });
      
      const layout = {
        margin: { l: 50, r: 30, t: 30, b: 50 },
        yaxis: { 
          title: 'Overall Performance Score',
          range: [1, 5]
        },
        template: 'plotly_white',
        showlegend: true
      };
      
      Plotly.newPlot('groupBoxPlots', traces, layout, { responsive: true });
    }

    // Chart 5: Correlation Matrix - UPDATED with only 6 skills
    function renderCorrelationMatrix(rows) {
      const metrics = ["Attendance", "Communication", "Accountability", "CreativityOwnership", 
                       "ProjectDelivery", "TechSkills"];
      
      // Calculate correlations
      const correlations = [];
      for (let i = 0; i < metrics.length; i++) {
        const row = [];
        for (let j = 0; j < metrics.length; j++) {
          const x = rows.map(r => r[metrics[i]]);
          const y = rows.map(r => r[metrics[j]]);
          row.push(calculateCorrelation(x, y));
        }
        correlations.push(row);
      }

      const data = [{
        type: 'heatmap',
        z: correlations,
        x: metrics.map(m => m.replace(/([A-Z])/g, ' $1').trim()),
        y: metrics.map(m => m.replace(/([A-Z])/g, ' $1').trim()),
        colorscale: 'RdBu',
        zmin: -1,
        zmax: 1,
        hoverongaps: false,
        hovertemplate: '%{x} vs %{y}<br>Correlation: %{z:.2f}<extra></extra>'
      }];

      const layout = {
        margin: {l:100,r:20,t:30,b:100},
        template: "plotly_white",
        height: 400,
        xaxis: {tickangle: -45}
      };

      Plotly.newPlot("correlationMatrix", data, layout, {responsive:true});
    }

    function calculateCorrelation(x, y) {
      const n = x.length;
      const sum_x = x.reduce((a, b) => a + b, 0);
      const sum_y = y.reduce((a, b) => a + b, 0);
      const sum_xy = x.reduce((a, b, i) => a + b * y[i], 0);
      const sum_x2 = x.reduce((a, b) => a + b * b, 0);
      const sum_y2 = y.reduce((a, b) => a + b * b, 0);
      
      const numerator = n * sum_xy - sum_x * sum_y;
      const denominator = Math.sqrt((n * sum_x2 - sum_x * sum_x) * (n * sum_y2 - sum_y * sum_y));
      
      return denominator === 0 ? 0 : numerator / denominator;
    }

    // NEW: Top Performers
    function renderTopPerformers(rows) {
      const container = document.getElementById('topPerformers');
      
      // Sort by overall average and take top 5
      const topPerformers = [...rows]
        .sort((a, b) => overallAvg(b) - overallAvg(a))
        .slice(0, 5);
      
      if (topPerformers.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-4">No data available</p>';
        return;
      }
      
      container.innerHTML = topPerformers.map(candidate => {
        const avg = overallAvg(candidate);
        const cat = category(candidate);
        
        return `
          <div class="flex items-center justify-between p-3 bg-green-50 border border-green-200 rounded-lg fade-in">
            <div class="flex items-center space-x-3">
              <div class="w-3 h-3 rounded-full bg-green-500"></div>
              <div>
                <p class="font-medium text-gray-800">${candidate.Candidate}</p>
                <p class="text-xs text-gray-600">${candidate.DevGroup}</p>
              </div>
            </div>
            <div class="text-right">
              <p class="text-sm font-bold text-green-600">${fmt(avg)}/5</p>
              <p class="text-xs text-gray-500">${Math.round(candidate.OverallScore)}%</p>
              <span class="status-badge excellent">${cat}</span>
            </div>
          </div>
        `;
      }).join('');
    }

    // NEW: At-Risk Candidates
    function renderAtRiskCandidates(rows) {
      const container = document.getElementById('atRiskCandidates');
      
      const atRiskCandidates = rows.filter(r => category(r) === "At-risk");
      
      if (atRiskCandidates.length === 0) {
        container.innerHTML = `
          <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
            <i data-feather="check-circle" class="w-6 h-6 text-green-500 mx-auto mb-2"></i>
            <p class="text-green-700 text-sm">No at-risk candidates identified</p>
          </div>
        `;
        feather.replace();
        return;
      }
      
      container.innerHTML = atRiskCandidates.map(candidate => {
        const avg = overallAvg(candidate);
        
        // Find primary concerns (scores <= 2)
        const concerns = [];
        if (candidate.Attendance <= 2) concerns.push('Attendance');
        if (candidate.Communication <= 2) concerns.push('Communication');
        if (candidate.Accountability <= 2) concerns.push('Accountability');
        if (candidate.CreativityOwnership <= 2) concerns.push('Creativity');
        if (candidate.ProjectDelivery <= 2) concerns.push('Project Delivery');
        if (candidate.TechSkills <= 2) concerns.push('Tech Skills');
        
        return `
          <div class="flex items-center justify-between p-3 bg-red-50 border border-red-200 rounded-lg fade-in">
            <div class="flex items-center space-x-3">
              <div class="w-3 h-3 rounded-full bg-red-500"></div>
              <div>
                <p class="font-medium text-gray-800">${candidate.Candidate}</p>
                <p class="text-xs text-red-600">${concerns.slice(0, 2).join(', ')}${concerns.length > 2 ? '...' : ''}</p>
              </div>
            </div>
            <div class="text-right">
              <p class="text-sm font-bold text-red-600">${fmt(avg)}/5</p>
              <p class="text-xs text-gray-500">${Math.round(candidate.OverallScore)}%</p>
              <span class="status-badge at-risk">At Risk</span>
            </div>
          </div>
        `;
      }).join('');
      
      feather.replace();
    }

    // Data table with color-coded rows - UPDATED with only 6 skills and overall score
    function renderTable(rows){
      const wrap = document.getElementById("tableWrap");
      const headers = ["Candidate","DevGroup","Scrum","Attendance","Communication","Accountability","Creativity & Ownership","Project Delivery","Tech Skills","Overall Score","Category"];
      
      wrap.innerHTML = `
        <table class="w-full">
          <thead>
            <tr class="bg-gray-50">
              ${headers.map(h => `<th class="text-left p-3 text-xs font-medium text-gray-500 uppercase tracking-wider">${h}</th>`).join("")}
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            ${rows.map(r => {
              const cat = category(r);
              const cls = cat === "At-risk" ? "tr-at-risk" : (cat === "Excellent" ? "tr-excellent" : "tr-moderate");
              return `
                <tr class="${cls} fade-in">
                  <td class="p-3 text-sm text-gray-800">${r.Candidate}</td>
                  <td class="p-3 text-sm text-gray-600">${r.DevGroup}</td>
                  <td class="p-3 text-sm text-gray-600">${r.Scrum}</td>
                  <td class="p-3 text-sm text-gray-600">${r.Attendance}</td>
                  <td class="p-3 text-sm text-gray-600">${r.Communication}</td>
                  <td class="p-3 text-sm text-gray-600">${r.Accountability}</td>
                  <td class="p-3 text-sm text-gray-600">${r.CreativityOwnership}</td>
                  <td class="p-3 text-sm text-gray-600">${r.ProjectDelivery}</td>
                  <td class="p-3 text-sm text-gray-600">${r.TechSkills}</td>
                  <td class="p-3 text-sm font-medium ${r.OverallScore >= 80 ? 'text-green-600' : r.OverallScore >= 60 ? 'text-amber-600' : 'text-red-600'}">
                    ${Math.round(r.OverallScore)}%
                  </td>
                  <td class="p-3 text-sm font-medium ${cat === 'At-risk' ? 'text-red-600' : cat === 'Excellent' ? 'text-green-600' : 'text-amber-600'}">${cat}</td>
                </tr>
              `;
            }).join("")}
          </tbody>
        </table>
      `;
      
      document.getElementById('candidateCount').textContent = rows.length;
    }

    // Generate insights
    function generateInsights(rows) {
      const insightsEl = document.getElementById('insightsContent');
      
      if (rows.length === 0) {
        insightsEl.innerHTML = '<p class="text-gray-500">No data available for the selected filters.</p>';
        return;
      }
      
      const atRiskCount = rows.filter(r => category(r) === "At-risk").length;
      const excellentCount = rows.filter(r => category(r) === "Excellent").length;
      const moderateCount = rows.filter(r => category(r) === "Moderate").length;
      
      const avgTech = rows.reduce((sum, r) => sum + r.TechSkills, 0) / rows.length;
      const avgSoft = rows.reduce((sum, r) => sum + softSkillAvg(r), 0) / rows.length;
      const avgOverallScore = rows.reduce((sum, r) => sum + r.OverallScore, 0) / rows.length;
      
      const lowAttendance = rows.filter(r => r.Attendance <= 2).length;
      const lowProjectDelivery = rows.filter(r => r.ProjectDelivery <= 2).length;
      
      let insightsHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="bg-blue-50 p-4 rounded-lg fade-in">
            <h4 class="font-semibold text-blue-800 mb-2">Performance Overview</h4>
            <ul class="text-sm text-blue-700 space-y-1">
              <li>• ${excellentCount} candidates (${Math.round(excellentCount/rows.length*100)}%) are performing excellently</li>
              <li>• ${moderateCount} candidates (${Math.round(moderateCount/rows.length*100)}%) are at moderate level</li>
              <li>• ${atRiskCount} candidates (${Math.round(atRiskCount/rows.length*100)}%) need immediate support</li>
              <li>• Average overall score: ${Math.round(avgOverallScore)}%</li>
            </ul>
          </div>
          
          <div class="bg-amber-50 p-4 rounded-lg fade-in">
            <h4 class="font-semibold text-amber-800 mb-2">Skill Analysis</h4>
            <ul class="text-sm text-amber-700 space-y-1">
              <li>• Average technical skills: ${fmt(avgTech)}/5</li>
              <li>• Average soft skills: ${fmt(avgSoft)}/5</li>
              <li>• ${lowAttendance} candidates have attendance issues</li>
              <li>• ${lowProjectDelivery} candidates struggle with project delivery</li>
            </ul>
          </div>
        </div>
        
        <div class="mt-6">
          <h4 class="font-semibold text-gray-800 mb-2">Recommendations</h4>
          <div class="bg-gray-50 p-4 rounded-lg">
            <ul class="text-sm text-gray-700 space-y-2">
              ${atRiskCount > 0 ? 
                `<li class="flex items-start fade-in">
                  <span class="text-red-500 mr-2">•</span>
                  <span>Create individual development plans for ${atRiskCount} at-risk candidates focusing on their weakest areas</span>
                </li>` : ''}
              ${avgTech < 3.5 ? 
                `<li class="flex items-start fade-in">
                  <span class="text-blue-500 mr-2">•</span>
                  <span>Implement technical skills workshops to improve the cohort's average technical competency</span>
                </li>` : ''}
              ${lowAttendance > 0 ? 
                `<li class="flex items-start fade-in">
                  <span class="text-amber-500 mr-2">•</span>
                  <span>Address attendance issues with ${lowAttendance} candidates through mentorship and support</span>
                </li>` : ''}
              <li class="flex items-start fade-in">
                <span class="text-green-500 mr-2">•</span>
                <span>Leverage ${excellentCount} high performers as peer mentors for knowledge sharing</span>
              </li>
            </ul>
          </div>
        </div>
      `;
      
      insightsEl.innerHTML = insightsHTML;
    }

    // Performance filter buttons
    function setupPerformanceFilters() {
      const filters = document.querySelectorAll('.performance-filter');
      filters.forEach(filter => {
        filter.addEventListener('click', function() {
          filters.forEach(f => f.classList.remove('active'));
          this.classList.add('active');
          
          const filterValue = this.getAttribute('data-filter');
          let filteredRows = filterData();
          
          if (filterValue !== 'all') {
            filteredRows = filteredRows.filter(r => category(r).toLowerCase().replace(' ', '-') === filterValue);
          }
          
          renderKPIs(filteredRows);
          renderTable(filteredRows);
          generateInsights(filteredRows);
        });
      });
    }

    // Enhanced Export functionality
    function setupExportFunctionality() {
      const exportBtn = document.getElementById('exportReportBtn');
      const exportModal = document.getElementById('exportModal');
      const closeExportModal = document.getElementById('closeExportModal');
      const cancelExport = document.getElementById('cancelExport');
      const confirmExport = document.getElementById('confirmExport');
      const exportFormatBtns = document.querySelectorAll('.export-format-btn');
      
      let selectedFormat = 'pdf';
      
      // Show export modal
      exportBtn.addEventListener('click', () => {
        exportModal.classList.remove('page-hidden');
        exportModal.classList.add('page-visible');
      });
      
      // Close export modal
      [closeExportModal, cancelExport].forEach(btn => {
        btn.addEventListener('click', () => {
          exportModal.classList.remove('page-visible');
          exportModal.classList.add('page-hidden');
        });
      });
      
      // Select export format
      exportFormatBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          exportFormatBtns.forEach(b => b.classList.remove('border-blue-500', 'bg-blue-50'));
          btn.classList.add('border-blue-500', 'bg-blue-50');
          selectedFormat = btn.getAttribute('data-format');
        });
      });
      
      // Confirm export
      confirmExport.addEventListener('click', async () => {
        exportModal.classList.remove('page-visible');
        exportModal.classList.add('page-hidden');
        
        // Show loading state
        const originalText = exportBtn.innerHTML;
        exportBtn.innerHTML = '<i data-feather="loader" class="animate-spin"></i> Exporting...';
        exportBtn.disabled = true;
        
        // Get export options
        const dataScope = document.querySelector('input[name="dataScope"]:checked').value;
        const includeSections = {};
        document.querySelectorAll('.section-checkbox').forEach(checkbox => {
          includeSections[checkbox.getAttribute('data-section')] = checkbox.checked;
        });
        
        try {
          if (selectedFormat === 'pdf') {
            await exportToPDF(dataScope, includeSections);
          } else {
            exportToCSV(dataScope, includeSections);
          }
        } catch (error) {
          console.error('Export failed:', error);
          alert('Export failed. Please try again.');
        } finally {
          // Reset button state
          exportBtn.innerHTML = originalText;
          exportBtn.disabled = false;
          feather.replace();
        }
      });
    }
    
    // Enhanced PDF Export with charts
    async function exportToPDF(dataScope, includeSections) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Get data based on scope
      const exportData = dataScope === 'all' ? ALL_DATA : filterData();
      const reportTitle = document.getElementById('reportTitle').value || 'MICT SP Performance Analysis Report';
      
      // Add header
      doc.setFontSize(20);
      doc.setTextColor(40, 40, 40);
      doc.text(reportTitle, 105, 20, { align: 'center' });
      
      doc.setFontSize(12);
      doc.setTextColor(100, 100, 100);
      doc.text(`Generated on ${new Date().toLocaleDateString()} | ${exportData.length} candidates`, 105, 30, { align: 'center' });
      
      let yPosition = 50;
      
      // Executive Summary
      if (includeSections.executive) {
        doc.setFontSize(16);
        doc.setTextColor(40, 40, 40);
        doc.text('Executive Summary', 20, yPosition);
        yPosition += 10;
        
        doc.setFontSize(10);
        doc.setTextColor(80, 80, 80);
        
        const atRiskCount = exportData.filter(r => category(r) === "At-risk").length;
        const excellentCount = exportData.filter(r => category(r) === "Excellent").length;
        const groups = unique(exportData.map(r => r.DevGroup));
        const avgOverallScore = exportData.reduce((sum, r) => sum + r.OverallScore, 0) / exportData.length;
        
        const summaryText = [
          `This report analyzes the performance of ${exportData.length} candidates across ${groups.length} development groups.`,
          `Key findings include:`,
          `• ${excellentCount} candidates (${Math.round(excellentCount/exportData.length*100)}%) are performing excellently`,
          `• ${atRiskCount} candidates (${Math.round(atRiskCount/exportData.length*100)}%) require immediate intervention`,
          `• Average overall score: ${Math.round(avgOverallScore)}%`,
          `• Development groups analyzed: ${groups.join(', ')}`
        ];
        
        summaryText.forEach(line => {
          if (yPosition > 270) {
            doc.addPage();
            yPosition = 20;
          }
          doc.text(line, 20, yPosition, { maxWidth: 170 });
          yPosition += 7;
        });
        
        yPosition += 10;
      }
      
      // Performance Metrics
      if (includeSections.kpis) {
        if (yPosition > 250) {
          doc.addPage();
          yPosition = 20;
        }
        
        doc.setFontSize(16);
        doc.setTextColor(40, 40, 40);
        doc.text('Performance Metrics', 20, yPosition);
        yPosition += 10;
        
        doc.setFontSize(10);
        const avg = key => {
          const vals = exportData.map(r=>r[key]).filter(v=>v!=null && !isNaN(v));
          return vals.length ? vals.reduce((a,b)=>a+b,0)/vals.length : NaN;
        };
        
        const metrics = [
          { label: 'Average Attendance', value: fmt(avg("Attendance")) + '/5' },
          { label: 'Average Accountability', value: fmt(avg("Accountability")) + '/5' },
          { label: 'Work Ready (Tech ≥ 4)', value: Math.round((exportData.filter(r=>r.TechSkills>=4).length/exportData.length*100)) + '%' },
          { label: 'Need Support', value: Math.round((exportData.filter(r=>isAtRisk(r)).length/exportData.length*100)) + '%' },
          { label: 'Average Overall Score', value: Math.round(exportData.reduce((sum, r) => sum + r.OverallScore, 0) / exportData.length) + '%' }
        ];
        
        metrics.forEach(metric => {
          if (yPosition > 270) {
            doc.addPage();
            yPosition = 20;
          }
          
          doc.setTextColor(40, 40, 40);
          doc.text(`${metric.label}:`, 25, yPosition);
          doc.setTextColor(59, 130, 246);
          doc.text(metric.value, 100, yPosition);
          yPosition += 7;
        });
        
        yPosition += 10;
      }
      
      // Group Performance Summary
      if (includeSections.kpis) {
        if (yPosition > 250) {
          doc.addPage();
          yPosition = 20;
        }
        
        doc.setFontSize(16);
        doc.setTextColor(40, 40, 40);
        doc.text('Group Performance Summary', 20, yPosition);
        yPosition += 10;
        
        doc.setFontSize(10);
        const groups = unique(exportData.map(r => r.DevGroup));
        
        groups.forEach(group => {
          if (yPosition > 270) {
            doc.addPage();
            yPosition = 20;
          }
          
          const groupData = exportData.filter(r => r.DevGroup === group);
          const groupAtRisk = groupData.filter(r => category(r) === "At-risk").length;
          const groupExcellent = groupData.filter(r => category(r) === "Excellent").length;
          const groupAvgScore = groupData.reduce((sum, r) => sum + r.OverallScore, 0) / groupData.length;
          
          doc.setTextColor(40, 40, 40);
          doc.text(`${group}:`, 25, yPosition);
          doc.setTextColor(100, 100, 100);
          doc.text(`${groupData.length} candidates, ${groupExcellent} excellent, ${groupAtRisk} at-risk, ${Math.round(groupAvgScore)}% avg score`, 60, yPosition);
          yPosition += 7;
        });
        
        yPosition += 10;
      }
      
      // Charts section - capture actual chart images
      if (includeSections.charts) {
        // Note: In a real implementation, you would capture chart images using Plotly.toImage
        // This is a simplified version that describes the charts
        
        if (yPosition > 250) {
          doc.addPage();
          yPosition = 20;
        }
        
        doc.setFontSize(16);
        doc.setTextColor(40, 40, 40);
        doc.text('Key Visualizations', 20, yPosition);
        yPosition += 10;
        
        doc.setFontSize(10);
        doc.setTextColor(80, 80, 80);
        
        const chartDescriptions = [
          "Performance Distribution: Pie chart showing Excellent, Moderate, and At-risk candidates",
          "Group Comparison: Bar chart comparing performance across development groups",
          "Skills Radar: Radar chart showing average scores across all assessment criteria",
          "Tech vs Soft Skills: Scatter plot comparing technical and soft skills",
          "Correlation Matrix: Heatmap showing relationships between different skills"
        ];
        
        chartDescriptions.forEach(desc => {
          if (yPosition > 270) {
            doc.addPage();
            yPosition = 20;
          }
          doc.text(`• ${desc}`, 25, yPosition, { maxWidth: 170 });
          yPosition += 7;
        });
        
        yPosition += 10;
      }
      
      // Risk Analysis
      if (includeSections.risk) {
        if (yPosition > 250) {
          doc.addPage();
          yPosition = 20;
        }
        
        doc.setFontSize(16);
        doc.setTextColor(40, 40, 40);
        doc.text('Risk Analysis', 20, yPosition);
        yPosition += 10;
        
        doc.setFontSize(10);
        const atRiskCandidates = exportData.filter(r => category(r) === "At-risk");
        
        if (atRiskCandidates.length > 0) {
          doc.setTextColor(239, 68, 68);
          doc.text('At-Risk Candidates Requiring Immediate Attention:', 25, yPosition);
          yPosition += 7;
          
          atRiskCandidates.forEach(candidate => {
            if (yPosition > 270) {
              doc.addPage();
              yPosition = 20;
            }
            doc.setTextColor(40, 40, 40);
            doc.text(`${candidate.Candidate} (${candidate.DevGroup}) - ${Math.round(candidate.OverallScore)}%`, 30, yPosition);
            doc.setTextColor(100, 100, 100);
            
            // Find low scores
            const lowScores = [];
            if (candidate.Attendance <= 2) lowScores.push('Attendance');
            if (candidate.Communication <= 2) lowScores.push('Communication');
            if (candidate.Accountability <= 2) lowScores.push('Accountability');
            if (candidate.CreativityOwnership <= 2) lowScores.push('Creativity & Ownership');
            if (candidate.ProjectDelivery <= 2) lowScores.push('Project Delivery');
            if (candidate.TechSkills <= 2) lowScores.push('Technical Skills');
            
            doc.text(`Low scores in: ${lowScores.join(', ')}`, 30, yPosition + 5);
            yPosition += 12;
          });
        } else {
          doc.setTextColor(16, 185, 129);
          doc.text('No at-risk candidates identified', 25, yPosition);
          yPosition += 7;
        }
        
        yPosition += 10;
      }
      
      // Recommendations
      if (includeSections.recommendations) {
        if (yPosition > 250) {
          doc.addPage();
          yPosition = 20;
        }
        
        doc.setFontSize(16);
        doc.setTextColor(40, 40, 40);
        doc.text('Key Recommendations', 20, yPosition);
        yPosition += 10;
        
        doc.setFontSize(10);
        
        const atRiskCount = exportData.filter(r => category(r) === "At-risk").length;
        const excellentCount = exportData.filter(r => category(r) === "Excellent").length;
        const avgTech = exportData.reduce((sum, r) => sum + r.TechSkills, 0) / exportData.length;
        const lowAttendance = exportData.filter(r => r.Attendance <= 2).length;
        
        const recommendations = [];
        
        if (atRiskCount > 0) {
          recommendations.push(`Create individual development plans for ${atRiskCount} at-risk candidates`);
        }
        if (avgTech < 3.5) {
          recommendations.push(`Implement technical skills workshops to improve average technical competency`);
        }
        if (lowAttendance > 0) {
          recommendations.push(`Address attendance issues with ${lowAttendance} candidates through mentorship`);
        }
        if (excellentCount > 0) {
          recommendations.push(`Leverage ${excellentCount} high performers as peer mentors`);
        }
        recommendations.push(`Continue monitoring all candidates with the performance tracking system`);
        
        recommendations.forEach(rec => {
          if (yPosition > 270) {
            doc.addPage();
            yPosition = 20;
          }
          doc.setTextColor(80, 80, 80);
          doc.text(`• ${rec}`, 25, yPosition, { maxWidth: 170 });
          yPosition += 7;
        });
        
        yPosition += 10;
      }
      
      // Detailed Data
      if (includeSections.detailed) {
        if (yPosition > 250) {
          doc.addPage();
          yPosition = 20;
        }
        
        doc.setFontSize(16);
        doc.setTextColor(40, 40, 40);
        doc.text('Candidate Details (Sample)', 20, yPosition);
        yPosition += 10;
        
        doc.setFontSize(8);
        
        // Add table headers
        const headers = ["Candidate", "Group", "Att", "Comm", "Acc", "Creat", "Proj", "Tech", "Score", "Category"];
        let xPosition = 20;
        headers.forEach(header => {
          doc.setTextColor(40, 40, 40);
          doc.text(header, xPosition, yPosition);
          xPosition += 18;
        });
        
        yPosition += 5;
        doc.line(20, yPosition, 200, yPosition);
        yPosition += 5;
        
        // Add sample data (first 10 candidates)
        const sampleData = exportData.slice(0, 10);
        sampleData.forEach(candidate => {
          if (yPosition > 270) {
            doc.addPage();
            yPosition = 20;
            // Add headers again on new page
            xPosition = 20;
            headers.forEach(header => {
              doc.setTextColor(40, 40, 40);
              doc.text(header, xPosition, yPosition);
              xPosition += 18;
            });
            yPosition += 10;
          }
          
          xPosition = 20;
          const values = [
            candidate.Candidate.substring(0, 8),
            candidate.DevGroup.substring(0, 5),
            candidate.Attendance,
            candidate.Communication,
            candidate.Accountability,
            candidate.CreativityOwnership,
            candidate.ProjectDelivery,
            candidate.TechSkills,
            Math.round(candidate.OverallScore) + '%',
            category(candidate).substring(0, 1)
          ];
          
          values.forEach((value, index) => {
            // Color code based on performance
            if (index >= 2 && index <= 7) { // Score columns
              if (value <= 2) doc.setTextColor(239, 68, 68);
              else if (value >= 4) doc.setTextColor(16, 185, 129);
              else doc.setTextColor(245, 158, 11);
            } else if (index === 8) { // Overall score column
              const score = parseInt(value);
              if (score >= 80) doc.setTextColor(16, 185, 129);
              else if (score >= 60) doc.setTextColor(245, 158, 11);
              else doc.setTextColor(239, 68, 68);
            } else {
              doc.setTextColor(80, 80, 80);
            }
            
            doc.text(String(value), xPosition, yPosition);
            xPosition += 18;
          });
          
          yPosition += 5;
        });
      }
      
      // Save the PDF
      doc.save(`${reportTitle.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.pdf`);
    }
    
    // Enhanced CSV Export
    function exportToCSV(dataScope, includeSections) {
      const exportData = dataScope === 'all' ? ALL_DATA : filterData();
      
      let csvContent = "data:text/csv;charset=utf-8,";
      const reportTitle = document.getElementById('reportTitle').value || 'MICT SP Performance Analysis Report';
      
      // Report header
      csvContent += `${reportTitle}\r\n`;
      csvContent += `Generated on,${new Date().toLocaleDateString()}\r\n`;
      csvContent += `Data Scope,${dataScope === 'all' ? 'All Data' : 'Filtered View'}\r\n`;
      csvContent += `Total Candidates,${exportData.length}\r\n`;
      csvContent += `Development Groups,${unique(exportData.map(r => r.DevGroup)).join('; ')}\r\n`;
      csvContent += "\r\n";
      
      // Performance Summary
      if (includeSections.executive) {
        csvContent += "PERFORMANCE SUMMARY\r\n";
        const atRiskCount = exportData.filter(r => category(r) === "At-risk").length;
        const excellentCount = exportData.filter(r => category(r) === "Excellent").length;
        const moderateCount = exportData.filter(r => category(r) === "Moderate").length;
        const avgOverallScore = exportData.reduce((sum, r) => sum + r.OverallScore, 0) / exportData.length;
        
        csvContent += `Excellent Candidates,${excellentCount},${Math.round(excellentCount/exportData.length*100)}%\r\n`;
        csvContent += `Moderate Candidates,${moderateCount},${Math.round(moderateCount/exportData.length*100)}%\r\n`;
        csvContent += `At-Risk Candidates,${atRiskCount},${Math.round(atRiskCount/exportData.length*100)}%\r\n`;
        csvContent += `Average Overall Score,${Math.round(avgOverallScore)}%\r\n`;
        csvContent += "\r\n";
      }
      
      // Group Performance
      if (includeSections.kpis) {
        csvContent += "GROUP PERFORMANCE\r\n";
        csvContent += "Group,Total Candidates,Excellent,Moderate,At-Risk,Avg Tech Skills,Avg Soft Skills,Avg Overall Score\r\n";
        
        const groups = unique(exportData.map(r => r.DevGroup));
        groups.forEach(group => {
          const groupData = exportData.filter(r => r.DevGroup === group);
          const excellent = groupData.filter(r => category(r) === "Excellent").length;
          const moderate = groupData.filter(r => category(r) === "Moderate").length;
          const atRisk = groupData.filter(r => category(r) === "At-risk").length;
          const avgTech = groupData.reduce((sum, r) => sum + r.TechSkills, 0) / groupData.length;
          const avgSoft = groupData.reduce((sum, r) => sum + softSkillAvg(r), 0) / groupData.length;
          const avgOverallScore = groupData.reduce((sum, r) => sum + r.OverallScore, 0) / groupData.length;
          
          csvContent += `${group},${groupData.length},${excellent},${moderate},${atRisk},${fmt(avgTech)},${fmt(avgSoft)},${Math.round(avgOverallScore)}%\r\n`;
        });
        csvContent += "\r\n";
      }
      
      // Risk Analysis
      if (includeSections.risk) {
        csvContent += "RISK ANALYSIS\r\n";
        csvContent += "Candidate,Group,Overall Score,Primary Concerns\r\n";
        
        const atRiskCandidates = exportData.filter(r => category(r) === "At-risk");
        atRiskCandidates.forEach(candidate => {
          const lowScores = [];
          if (candidate.Attendance <= 2) lowScores.push('Attendance');
          if (candidate.Communication <= 2) lowScores.push('Communication');
          if (candidate.Accountability <= 2) lowScores.push('Accountability');
          if (candidate.CreativityOwnership <= 2) lowScores.push('Creativity & Ownership');
          if (candidate.ProjectDelivery <= 2) lowScores.push('Project Delivery');
          if (candidate.TechSkills <= 2) lowScores.push('Technical Skills');
          
          csvContent += `"${candidate.Candidate}","${candidate.DevGroup}","${Math.round(candidate.OverallScore)}%","${lowScores.join('; ')}"\r\n`;
        });
        csvContent += "\r\n";
      }
      
      // Detailed Data
      if (includeSections.detailed) {
        csvContent += "DETAILED CANDIDATE DATA\r\n";
        const headers = ["Candidate","DevGroup","Scrum","Attendance","Communication","Accountability",
                        "CreativityOwnership","ProjectDelivery","TechSkills","OverallScore","Category"];
        csvContent += headers.join(",") + "\r\n";
        
        exportData.forEach(row => {
          const values = [
            `"${row.Candidate}"`,
            row.DevGroup,
            `"${row.Scrum}"`,
            row.Attendance,
            row.Communication,
            row.Accountability,
            row.CreativityOwnership,
            row.ProjectDelivery,
            row.TechSkills,
            Math.round(row.OverallScore) + '%',
            category(row)
          ];
          csvContent += values.join(",") + "\r\n";
        });
      }
      
      // Create download link
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "comprehensive_performance_report.csv");
      document.body.appendChild(link);
      
      // Trigger download
      link.click();
      document.body.removeChild(link);
    }

    // Orchestrate updates
    function update() {
      const rows = filterData();
      
      renderKPIs(rows);
      renderPerformanceTrends(rows);
      renderOverallCategory(rows);
      renderGroupComparison(rows);
      renderSkillDistribution(rows);
      renderCriteriaRadar(rows);
      renderTechSoftScatter(rows);
      renderGroupBoxPlots(rows);
      renderCorrelationMatrix(rows);
      renderTopPerformers(rows);
      renderAtRiskCandidates(rows);
      renderTable(rows);
      generateInsights(rows);
    }

    // Initialize the dashboard
    function initDashboard() {
      initFilters();
      update();
      setupPerformanceFilters();
      setupExportFunctionality();
      
      // Add event listeners
      groupSel.addEventListener('change', update);
      weekSel.addEventListener('change', update);
      searchIn.addEventListener('input', () => {
        clearTimeout(window.__searchTimer);
        window.__searchTimer = setTimeout(update, 300);
      });
      resetBtn.addEventListener('click', () => {
        initFilters();
        update();
      });
    }

    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      const loadingIndicator = document.getElementById('loadingIndicator');
      const mainContent = document.getElementById('mainContent');
      
      setTimeout(() => {
        if (typeof initDashboard === 'function') {
          initDashboard();
        }
        
        loadingIndicator.style.display = 'none';
        mainContent.classList.remove('opacity-0');
        
        if (typeof feather !== 'undefined') {
          feather.replace();
        }
      }, 100);
    });
  </script>
</body>
</html>